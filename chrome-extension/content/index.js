/*
Rega
<input type="checkbox" name="projecto_plantacao[rega]" value="1" id="projecto_plantacao_rega" class="check_area bloqueia">

  Correção do solo
<input type="checkbox" name="projecto_plantacao_preparacao_terreno[correcao_solo]" value="1" id="projecto_plantacao_preparacao_terreno_correcao_solo" class="check_area  bloqueia">
  ha -> <input class="form-control input-group money area_local_mask depende_area_plantacao pull-right form-control" type="text" name="projecto_plantacao_preparacao_terreno[area_correcao_solo]" value="" id="projecto_plantacao_preparacao_terreno_area_correcao_solo" size="12" data-bv-notempty="true" data-bv-trigger="change blur" data-bv-greaterthan="true" data-bv-greaterthan-value="0.001" data-bv-field="projecto_plantacao_preparacao_terreno[area_correcao_solo]" data-bv-lessthan="true" data-bv-lessthan-value="">
  t -> <input class="form-control input-group money area_local_mask form-control" type="text" name="projecto_plantacao_preparacao_terreno[valor_fator_correcao_solo]" value="0" id="projecto_plantacao_preparacao_terreno_valor_fator_correcao_solo" size="12" data-bv-notempty="true" data-bv-trigger="change blur" data-bv-greaterthan="true" data-bv-greaterthan-value="0.001" data-bv-field="projecto_plantacao_preparacao_terreno[valor_fator_correcao_solo]">

  Drenagem
  <input type="checkbox" name="projecto_plantacao_preparacao_terreno[drenagem]" value="1" id="projecto_plantacao_preparacao_terreno_drenagem" class="check_area  bloqueia">
  <input class="form-control input-group money area_local_mask depende_area_plantacao pull-right form-control" type="text" name="projecto_plantacao_preparacao_terreno[area_drenagem]" value="" id="projecto_plantacao_preparacao_terreno_area_drenagem" size="12" data-bv-notempty="true" data-bv-trigger="change blur" data-bv-greaterthan="true" data-bv-greaterthan-value="0.001" data-bv-field="projecto_plantacao_preparacao_terreno[area_drenagem]" data-bv-lessthan="true" data-bv-lessthan-value="">

  Escarificação

  <input type="checkbox" name="projecto_plantacao_preparacao_terreno[escarificacao]" value="1" id="projecto_plantacao_preparacao_terreno_escarificacao" class="check_area  bloqueia">
  <input class="form-control input-group money area_local_mask depende_area_plantacao pull-right form-control" type="text" name="projecto_plantacao_preparacao_terreno[area_escarificacao]" value="" id="projecto_plantacao_preparacao_terreno_area_escarificacao" size="12" data-bv-notempty="true" data-bv-trigger="change blur" data-bv-greaterthan="true" data-bv-greaterthan-value="0.001" data-bv-field="projecto_plantacao_preparacao_terreno[area_escarificacao]" data-bv-lessthan="true" data-bv-lessthan-value="">

  Gradagem

  <input type="checkbox" name="projecto_plantacao_preparacao_terreno[gradagem]" value="1" id="projecto_plantacao_preparacao_terreno_gradagem" class="check_area  bloqueia">
  <input class="form-control input-group money area_local_mask depende_area_plantacao pull-right form-control" type="text" name="projecto_plantacao_preparacao_terreno[area_gradagem]" value="" id="projecto_plantacao_preparacao_terreno_area_gradagem" size="12" data-bv-notempty="true" data-bv-trigger="change blur" data-bv-greaterthan="true" data-bv-greaterthan-value="0.001" data-bv-field="projecto_plantacao_preparacao_terreno[area_gradagem]" data-bv-lessthan="true" data-bv-lessthan-value="">

  Lavoura profunda

<input type="checkbox" name="projecto_plantacao_preparacao_terreno[lavoura_profunda]" value="1" id="projecto_plantacao_preparacao_terreno_lavoura_profunda" class="check_area das3uma bloqueia">
  <input class="form-control input-group money area_local_mask depende_area_plantacao pull-right form-control" type="text" name="projecto_plantacao_preparacao_terreno[area_lavoura_profunda]" value="" id="projecto_plantacao_preparacao_terreno_area_lavoura_profunda" size="12" data-bv-notempty="true" data-bv-trigger="change blur" data-bv-greaterthan="true" data-bv-greaterthan-value="0.001" data-bv-field="projecto_plantacao_preparacao_terreno[area_lavoura_profunda]" data-bv-lessthan="true" data-bv-lessthan-value="">

  Matéria Orgânica

<input type="checkbox" name="projecto_plantacao_preparacao_terreno[materia_organica]" value="1" id="projecto_plantacao_preparacao_terreno_materia_organica" class="check_area  bloqueia">
  <input class="form-control input-group money area_local_mask depende_area_plantacao pull-right form-control" type="text" name="projecto_plantacao_preparacao_terreno[area_materia_organica]" value="" id="projecto_plantacao_preparacao_terreno_area_materia_organica" size="12" data-bv-notempty="true" data-bv-trigger="change blur" data-bv-greaterthan="true" data-bv-greaterthan-value="0.001" data-bv-field="projecto_plantacao_preparacao_terreno[area_materia_organica]" data-bv-lessthan="true" data-bv-lessthan-value="">
  <input class="form-control input-group money area_local_mask form-control" type="text" name="projecto_plantacao_preparacao_terreno[valor_fator_materia_organica]" value="0" id="projecto_plantacao_preparacao_terreno_valor_fator_materia_organica" size="12" data-bv-notempty="true" data-bv-trigger="change blur" data-bv-greaterthan="true" data-bv-greaterthan-value="0.001" data-bv-field="projecto_plantacao_preparacao_terreno[valor_fator_materia_organica]">

  Ripagem cruzada

<input type="checkbox" name="projecto_plantacao_preparacao_terreno[ripagem_cruzada]" value="1" id="projecto_plantacao_preparacao_terreno_ripagem_cruzada" class="check_area das3uma bloqueia">
  <input class="form-control input-group money area_local_mask depende_area_plantacao pull-right form-control" type="text" name="projecto_plantacao_preparacao_terreno[area_ripagem_cruzada]" value="" id="projecto_plantacao_preparacao_terreno_area_ripagem_cruzada" size="12" data-bv-notempty="true" data-bv-trigger="change blur" data-bv-greaterthan="true" data-bv-greaterthan-value="0.001" data-bv-field="projecto_plantacao_preparacao_terreno[area_ripagem_cruzada]" data-bv-lessthan="true" data-bv-lessthan-value="">

  Surriba

  <input type="checkbox" name="projecto_plantacao_preparacao_terreno[surriba]" value="1" id="projecto_plantacao_preparacao_terreno_surriba" class="check_area das3uma bloqueia">
  <input class="form-control input-group money area_local_mask depende_area_plantacao pull-right form-control" type="text" name="projecto_plantacao_preparacao_terreno[area_surriba]" value="" id="projecto_plantacao_preparacao_terreno_area_surriba" size="12" data-bv-notempty="true" data-bv-trigger="change blur" data-bv-greaterthan="true" data-bv-greaterthan-value="0.001" data-bv-field="projecto_plantacao_preparacao_terreno[area_surriba]" data-bv-lessthan="true" data-bv-lessthan-value="">

  Terraceamento

  <input type="checkbox" name="projecto_plantacao_preparacao_terreno[terraceamento]" value="1" id="projecto_plantacao_preparacao_terreno_terraceamento" class="check_area  bloqueia">
  <input class="form-control input-group money area_local_mask depende_area_plantacao pull-right form-control" type="text" name="projecto_plantacao_preparacao_terreno[area_terraceamento]" value="" id="projecto_plantacao_preparacao_terreno_area_terraceamento" size="12" data-bv-notempty="true" data-bv-trigger="change blur" data-bv-greaterthan="true" data-bv-greaterthan-value="0.001" data-bv-field="projecto_plantacao_preparacao_terreno[area_terraceamento]" data-bv-lessthan="true" data-bv-lessthan-value="">

  Estrutura Anti-granizo

<input type="checkbox" name="projecto_plantacao[estrutura_anti_granizo]" value="1" id="projecto_plantacao_estrutura_anti_granizo" class="check_area  bloqueia">
  <input class="form-control input-group money area_local_mask depende_area_plantacao pull-right form-control" type="text" name="projecto_plantacao[area_estrutura_anti_granizo]" value="" id="projecto_plantacao_area_estrutura_anti_granizo" size="12" data-bv-notempty="true" data-bv-trigger="change blur" data-bv-greaterthan="true" data-bv-greaterthan-value="0.001" data-bv-field="projecto_plantacao[area_estrutura_anti_granizo]" data-bv-lessthan="true" data-bv-lessthan-value="">
*/

chrome.extension.onMessage.addListener((msg, sender, sendResponse) => {
  const title = getElement("title-dropdown-menu");
  const firstName = getElement("firstName-input-field");
  const lastName = getElement("lastName-input-field");
  const mobile = getElement("mobile-input-field");
  const email = getElement("email-input-field");


  const itemToFormOption = {
    "area": {
      input: {
        id: "projecto_plantacao_area_total"
      }
    },
    density: {
      input: {
        id: "projecto_plantacao_densidade_plantacao"
      }
    },
    "rega": {
      checkInput: {
        id: "projecto_plantacao_rega"
      }
    },
    "13": {
      checkInput: {
        id: "projecto_plantacao_fertilizacao"
      },
      areaInput: {
        id: "projecto_plantacao_area_fertilizacao"
      }
    },
    "16": {
      checkInput: {
        id: "projecto_plantacao_preparacao_terreno_desmatacao"
      },
      areaInput: {
        id: "projecto_plantacao_preparacao_terreno_area_desmatacao"
      }
    },
    "19": {
      checkInput: {
        id: "projecto_plantacao_preparacao_terreno_despedrega"
      },
      areaInput: {
        id: "projecto_plantacao_preparacao_terreno_area_despedrega"
      }
    },
    "20": {
      checkInput: {
        id: "projecto_plantacao_preparacao_terreno_escarificacao"
      },
      areaInput: {
        id: "projecto_plantacao_preparacao_terreno_area_escarificacao"
      }
    },
    "23": {
      checkInput: {
        id: "projecto_plantacao_preparacao_terreno_area_materia_organica"
      },
      areaInput: {
        id: "projecto_plantacao_preparacao_terreno_valor_fator_materia_organica"
      }
    },
    "24": {
      checkInput: {
        id: "projecto_plantacao_preparacao_terreno_gradagem"
      },
      areaInput: {
        id: "projecto_plantacao_preparacao_terreno_area_gradagem"
      }
    },
    "correcaoSolo": {
      checkInput: {
        id: "projecto_plantacao_preparacao_terreno_correcao_solo"
      },
      areaInput: {
        id: "projecto_plantacao_preparacao_terreno_area_correcao_solo"
      },
      quantityInput: {
        id: "projecto_plantacao_preparacao_terreno_valor_fator_correcao_solo"
      },
    }
  }

  function getDensity({ size, items}) {
      const plantsNumber = items[11][0].quantity
      return Math.floor(plantsNumber / size)
  }

  function fillLocationInformation( { name, type, size: rawSize, items }) {
    const size = parseFloat(rawSize.replace(",","."))
    changeText(itemToFormOption['area']['input']['id'], size)
    changeText(itemToFormOption['density']['input']['id'], getDensity({items, size }))
  }

  function fillItemsInformation({ items, size:rawSize }) {

    const size = parseFloat(rawSize.replace(",","."))

    function fillItem({ dossierId }, size) {
      changeCheckbox(itemToFormOption[dossierId].checkInput.id)
      changeText(itemToFormOption[dossierId].areaInput.id, size)
    }

    Object.entries(items).forEach( ( [dossierId, item ]) => {

      switch (dossierId) {
        case "13":
          fillItem(item[0], size);
          break;
        case "16":
          fillItem(item[0], size)
          break;
        case "19":
          fillItem(item[0], size)
          break;
        case "20":
          fillItem(item[0], size)
          break;
        case "23":
          fillItem(item[0], size)
          break;
        case "24":
          fillItem(item[0], size)
          break;
      }

    })


  }

  function fillForm() {
    // changeSelect(title, "mr");
    chrome.storage.local.get(['location'],
      ({location}) => {
        const {name, type, size, items} = JSON.parse(location)
        console.log({name, type, size, items})
        fillLocationInformation({ name, type, size, items })
        fillItemsInformation({items, size})
      })
    /*const enterAddressManually = getElement("manual-lookup-form");
    click(enterAddressManually);
    let addressLine1Id = getElement("line1-input-field")
    let townId
    if (typeof (addressLine1Id) != 'undefined' && addressLine1Id != null) {
      addressLine1Id="line1-input-field"
      townId = "city-input-field";
    } else {
      addressLine1Id = "addressLine1-input-field";
      townId = "town-input-field";
    }
    const addressLine1 = getElement(addressLine1Id);
    const town = getElement(townId);
    const postcode = getElement("postcode-input-field");
    changeText(addressLine1, "1 Somewhere");
    changeText(town, "London");
    changeText(postcode, "WC1 1AA");*/

    /*setTimeout(() => {
      const useAddress = getElement("use-address-button");
      const form = useAddress.parentElement.parentElement;
      dispatchEvent(form, "submit");
    }, 100);*/
  }

  console.log({content: 'XXXXXX', msg})

  if (msg.action === "Fill-Form") {
    fillForm();
  }
})
;